CREATE UNLOGGED TABLE GPAandProgress AS SELECT StudentRegistrationsToDegrees.StudentRegistrationId, SUM(CourseRegistrations.Grade * Courses.ECTS) / CAST(SUM(Courses.ECTS) AS float) AS GPA, CAST(CASE WHEN SUM(Courses.ECTS) < Degrees.TotalECTS AND SUM(Courses.ECTS) IS NOT NULL THEN 1 WHEN SUM(Courses.ECTS) > Degrees.TotalECTS AND SUM(Courses.ECTS) IS NOT NULL THEN 2 ELSE 0 END AS integer) AS Completion FROM StudentRegistrationsToDegrees, CourseRegistrations, CourseOffers, Courses, Degrees WHERE StudentRegistrationsToDegrees.StudentRegistrationId = CourseRegistrations.StudentRegistrationId AND CourseRegistrations.CourseOfferId = CourseOffers.CourseOfferId AND CourseOffers.CourseId = Courses.CourseId AND StudentRegistrationsToDegrees.DegreeId = Degrees.DegreeId AND CourseRegistrations.Grade >= 5.0 GROUP BY StudentRegistrationsToDegrees.StudentRegistrationId, Degrees.TotalECTS;

